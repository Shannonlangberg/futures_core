<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Futures Church Dashboard</title>
  <!-- Cache Bust: v2.1 -->
  <link rel="icon" href="/Futures1white.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #1e293b;
      min-height: 100vh;
      height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: #f1f5f9;
      overflow: hidden;
      position: relative;
    }

    .dashboard-container {
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      background: #1e293b;
    }

    /* Top Bar */
    .top-bar {
      background: #334155;
      border-bottom: 1px solid #475569;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: url('/Futures1white.png') no-repeat center/contain;
    }

    .title {
      font-family: 'Inter', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: #f1f5f9;
      letter-spacing: -0.025em;
    }

    .title .accent {
      color: #60a5fa;
    }

    /* Main Content */
    .main-content {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
      height: calc(100vh - 120px); /* Fill remaining height after top bar and bottom nav */
    }

    /* Left Panel - Enhanced Stats */
    .stats-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 440px;
      max-width: 440px;
      height: 100%;
      overflow-y: auto;
      justify-content: flex-start;
      padding: 0 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .stats-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .stat-group {
      background: rgba(96,165,250,0.05);
      border: 1px solid rgba(96,165,250,0.2);
      border-radius: 12px;
      padding: 12px;
    }

    .group-title {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 0.8rem;
      color: #60a5fa;
      margin-bottom: 8px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card.mini {
      padding: 8px 10px;
      margin-bottom: 6px;
      min-height: 50px;
    }

    .stat-card.mini .stat-label {
      font-size: 0.65rem;
      margin-bottom: 2px;
    }

    .stat-card.mini .stat-number {
      font-size: 1rem;
    }

    .clickable-stat {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .clickable-stat:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(96,165,250,0.3);
      border-color: #60a5fa;
    }

    .clickable-stat:active {
      transform: translateY(0);
    }

    .panel-title {
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      color: #60a5fa;
      text-align: center;
      margin-bottom: 8px;
      letter-spacing: 0;
      font-weight: 500;
      flex-shrink: 0;
    }

    .stat-card {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
      flex: 1;
    }

    .stat-card:hover {
      border-color: #60a5fa;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }

    .stat-label {
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: 0;
    }

    .stat-number {
      font-family: 'Inter', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: #f1f5f9;
    }

    /* Central Orb */
    .orb-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .orb {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .orb-status {
      text-align: center;
      margin-top: 20px;
    }

    .status-text {
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      color: #60a5fa;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .listening-text {
      font-family: 'Inter', sans-serif;
      font-size: 1.2rem;
      color: #10b981;
      font-weight: 600;
      animation: textPulse 2s ease-in-out infinite alternate;
    }

    @keyframes textPulse {
      0% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    .transcript-display {
      margin-top: 15px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      max-width: 300px;
    }

    .transcript-title {
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      color: #94a3b8;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .transcript-text {
      font-size: 0.9rem;
      color: #f1f5f9;
      line-height: 1.3;
    }

    /* Right Panel - Info (Symmetrical) */
    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 440px;
      max-width: 440px;
      height: 100%;
      overflow-y: auto;
      justify-content: space-between;
      padding: 0 20px;
    }

    .info-card {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
      flex: 1;
    }

    .info-card:hover {
      border-color: #60a5fa;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }

    .dashboard-card {
      cursor: pointer !important;
      transition: all 0.3s ease !important;
    }

    .dashboard-card:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 12px 30px rgba(96,165,250,0.4) !important;
      border-color: #60a5fa !important;
    }

    .info-title {
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: 0;
    }

    .info-content {
      font-family: 'Inter', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: #f1f5f9;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: #334155;
      border: 1px solid #475569;
      border-radius: 12px;
      padding: 12px 24px;
      display: flex;
      gap: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
    }

    .nav-item {
      color: #94a3b8;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .nav-item:hover {
      background: #475569;
      color: #f1f5f9;
      transform: translateY(-1px);
    }

    /* Input Modal */
    .input-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .input-content {
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .input-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 20px;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #475569;
      border-radius: 8px;
      background: #334155;
      color: #f1f5f9;
      font-size: 1rem;
      margin-bottom: 20px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .input-field:focus {
      border-color: #60a5fa;
    }

    .input-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .input-btn {
      padding: 10px 20px;
      border: 1px solid #60a5fa;
      border-radius: 8px;
      background: #60a5fa;
      color: #ffffff;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .input-btn:hover {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .input-btn.cancel {
      background: transparent;
      color: #94a3b8;
      border-color: #475569;
    }

    .input-btn.cancel:hover {
      background: rgba(255,126,94,0.2);
    }

    /* Stat Logging Modal */
    .stat-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(30,41,59,0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .stat-modal-content {
      background: rgba(30,41,59,0.98);
      border: 2px solid #60a5fa;
      border-radius: 20px;
      padding: 30px;
      max-width: 450px;
      width: 90%;
      position: relative;
      text-align: center;
    }

    .stat-modal-title {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.3rem;
      color: #60a5fa;
      margin-bottom: 15px;
    }

    .stat-modal-campus {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    .stat-modal-input {
      width: 100%;
      background: rgba(51,65,85,0.8);
      border: 2px solid rgba(96,165,250,0.3);
      border-radius: 12px;
      padding: 15px;
      color: #fff;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 25px;
      outline: none;
      transition: all 0.3s ease;
    }

    .stat-modal-input:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 20px rgba(96,165,250,0.3);
    }

    .stat-modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .modal-btn {
      background: rgba(96,165,250,0.2);
      border: 2px solid #60a5fa;
      border-radius: 10px;
      padding: 10px 20px;
      color: #60a5fa;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    .modal-btn:hover {
      background: rgba(96,165,250,0.3);
      transform: translateY(-2px);
    }

    .modal-btn.cancel {
      border-color: #ef4444;
      color: #ef4444;
    }

    .modal-btn.cancel:hover {
      background: rgba(239,68,68,0.2);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
    }

    .submit-stats-btn, .clear-stats-btn {
      background: #3b82f6;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 24px;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 160px;
    }

    .submit-stats-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: #2563eb;
    }

    .clear-stats-btn {
      background: #ef4444;
      border-color: #ef4444;
      color: #ffffff;
    }

    .clear-stats-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: #dc2626;
    }

    .submit-stats-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .help-btn {
      background: rgba(96,165,250,0.2);
      border: 2px solid rgba(96,165,250,0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: #60a5fa;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }

    .help-btn:hover {
      background: rgba(96,165,250,0.3);
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(96,165,250,0.3);
    }

    /* Help Overlay */
    .help-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(30,41,59,0.95);
      backdrop-filter: blur(10px);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .help-content {
      background: rgba(30,41,59,0.98);
      border: 2px solid #60a5fa;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .help-title {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.5rem;
      color: #60a5fa;
      text-align: center;
      margin-bottom: 20px;
    }

    .help-section {
      margin-bottom: 20px;
    }

    .help-section h3 {
      font-family: 'Inter', Arial, sans-serif;
      color: #94a3b8;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .help-examples {
      background: rgba(96,165,250,0.1);
      border-left: 3px solid #60a5fa;
      padding: 10px 15px;
      margin: 10px 0;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .help-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .help-close:hover {
      color: #fff;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        padding: 10px;
      }
      
      .stats-panel, .info-panel {
        min-width: 100%;
        max-width: 100%;
        height: auto;
        padding: 0 10px;
      }
      
      .orb {
        width: 150px;
        height: 150px;
      }
      
      .bottom-nav {
        padding: 8px 15px;
        gap: 15px;
      }

      .nav-item {
        font-size: 0.9rem;
        width: 28px;
        height: 28px;
      }
        
      .stat-card, .info-card {
        padding: 10px;
      }
      
      .stat-number {
        font-size: 1.2rem;
      }
      
      .info-content {
        font-size: 1.0rem;
      }
    }
  </style>
  <script src="https://unpkg.com/tsparticles@1.43.1/tsparticles.min.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="logo"></div>
      <div class="title">
        Futures Church <span class="accent">Voice Assistant</span>
      </div>
      <div style="width: 32px;"></div> <!-- Spacer for center alignment -->
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel - Enhanced Stats -->
      <div class="stats-panel">
        <div class="panel-title">Weekly Statistics</div>
        <div class="stats-grid">
          <!-- Column 1 -->
          <div class="stats-column">
            <!-- Main Attendance -->
            <div class="stat-card clickable-stat" onclick="logStat('total_attendance')" title="Click to log">
              <div class="stat-label">Total Attendance</div>
              <div class="stat-number" id="stat-attendance">‚Äî</div>
            </div>
            
            <!-- New People Breakdown -->
            <div class="stat-group">
              <div class="group-title">New People</div>
              <div class="stat-card mini clickable-stat" onclick="logStat('first_time_visitors')" title="Click to log">
                <div class="stat-label">First Time</div>
                <div class="stat-number" id="stat-first-time">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('visitors')" title="Click to log">
                <div class="stat-label">Visitors</div>
                <div class="stat-number" id="stat-visitors">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('information_gathered')" title="Click to log">
                <div class="stat-label">Info Gathered</div>
                <div class="stat-number" id="stat-info">‚Äî</div>
              </div>
            </div>
            
            <!-- Christian Decisions Breakdown -->
            <div class="stat-group">
              <div class="group-title">New Christians</div>
              <div class="stat-card mini clickable-stat" onclick="logStat('first_time_christians')" title="Click to log">
                <div class="stat-label">First Time</div>
                <div class="stat-number" id="stat-first-time-christians">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('rededications')" title="Click to log">
                <div class="stat-label">Rededications</div>
                <div class="stat-number" id="stat-rededications">‚Äî</div>
              </div>
            </div>
            
            <!-- Youth Breakdown -->
            <div class="stat-group">
              <div class="group-title">Youth</div>
              <div class="stat-card mini clickable-stat" onclick="logStat('youth_attendance')" title="Click to log">
                <div class="stat-label">Attendance</div>
                <div class="stat-number" id="stat-youth">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('youth_salvations')" title="Click to log">
                <div class="stat-label">Salvations</div>
                <div class="stat-number" id="stat-youth-salvations">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('youth_new_people')" title="Click to log">
                <div class="stat-label">New People</div>
                <div class="stat-number" id="stat-youth-new">‚Äî</div>
              </div>
            </div>
          </div>
          
          <!-- Column 2 -->
          <div class="stats-column">
            <!-- Kids Breakdown -->
            <div class="stat-group">
              <div class="group-title">Kids</div>
              <div class="stat-card mini clickable-stat" onclick="logStat('kids_attendance')" title="Click to log">
                <div class="stat-label">Attendance</div>
                <div class="stat-number" id="stat-kids">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('kids_leaders')" title="Click to log">
                <div class="stat-label">Leaders</div>
                <div class="stat-number" id="stat-kids-leaders">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('new_kids')" title="Click to log">
                <div class="stat-label">New Kids</div>
                <div class="stat-number" id="stat-new-kids">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('new_kids_salvations')" title="Click to log">
                <div class="stat-label">Salvations</div>
                <div class="stat-number" id="stat-kids-salvations">‚Äî</div>
              </div>
            </div>
            
            <!-- Ministry Metrics -->
            <div class="stat-card clickable-stat" onclick="logStat('connect_groups')" title="Click to log">
              <div class="stat-label">Connect Groups</div>
              <div class="stat-number" id="stat-connect">‚Äî</div>
            </div>
            
            <div class="stat-card clickable-stat" onclick="logStat('tithe')" title="Click to log">
              <div class="stat-label">Tithe</div>
              <div class="stat-number" id="stat-tithe">‚Äî</div>
            </div>
            
            <div class="stat-card clickable-stat" onclick="logStat('dream_team')" title="Click to log">
              <div class="stat-label">Dream Team</div>
              <div class="stat-number" id="stat-dream-team">‚Äî</div>
            </div>
            
            <!-- Special Events -->
            <div class="stat-group">
              <div class="group-title">Special Events</div>
              <div class="stat-card mini clickable-stat" onclick="logStat('baptisms')" title="Click to log">
                <div class="stat-label">Baptisms</div>
                <div class="stat-number" id="stat-baptisms">‚Äî</div>
              </div>
              <div class="stat-card mini clickable-stat" onclick="logStat('child_dedications')" title="Click to log">
                <div class="stat-label">Child Dedications</div>
                <div class="stat-number" id="stat-child-dedications">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Central Orb -->
      <div class="orb-container">
        <div class="orb" id="particles-orb" onclick="showModal()">
          <!-- Particles will be injected here -->
        </div>
        <div class="orb-status">
          <div class="status-text">
            {% if current_user.is_authenticated %}
              {% if current_user.has_permission('recall_stats') %}
                Voice Assistant
              {% else %}
                Stats Logger
              {% endif %}
            {% else %}
              Voice Assistant
            {% endif %}
          </div>
          <div class="listening-text" id="listening-text">
            {% if current_user.is_authenticated %}
              {% if current_user.has_permission('recall_stats') %}
                Ready for queries & logging
              {% else %}
                Ready for logging
              {% endif %}
            {% else %}
              Ready
            {% endif %}
          </div>
          <div class="transcript-display" id="transcript-display" style="display: none;">
            <div class="transcript-title">Heard:</div>
            <div class="transcript-text" id="transcript-text"></div>
          </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="action-buttons">
          <button id="submitStatsBtn" class="submit-stats-btn" onclick="submitAllStats()" style="display: none;">
            Submit Stats
          </button>
          <button id="clearStatsBtn" class="clear-stats-btn" onclick="clearAllStats()" style="display: none;">
            Clear All
          </button>
          <button id="helpBtn" class="help-btn" onclick="showHelpOverlay()" title="Show help and examples">
            ?
          </button>
        </div>
      </div>

      <!-- Right Panel - Info (Symmetrical) -->
      <div class="info-panel">
        <div class="panel-title">System Information</div>
        <div class="info-card">
          <div class="info-title">System Status</div>
          <div class="info-content">Online</div>
        </div>
        <div class="info-card">
          <div class="info-title">Voice Recognition</div>
          <div class="info-content">Active</div>
        </div>
        <div class="info-card dashboard-card" onclick="openDashboard()">
          <div class="info-title">Dashboard</div>
          <div class="info-content">Click to view</div>
        </div>
        {% if current_user.is_authenticated and current_user.has_permission('finance_access') %}
        <div class="info-card dashboard-card" onclick="openFinance()">
          <div class="info-title">Finance</div>
          <div class="info-content">Tithe Logging</div>
        </div>
        {% endif %}
        <div class="info-card">
          <div class="info-title">Current Date</div>
          <div class="info-content" id="current-date">‚Äî</div>
        </div>
        <div class="info-card">
          <div class="info-title">Campus Select</div>
          <div class="info-content">
            <select id="campus-select" style="
              background: rgba(51,65,85,0.8);
              border: 1px solid rgba(96,165,250,0.3);
              border-radius: 6px;
              color: #60a5fa;
              font-family: 'Inter', Arial, sans-serif;
              font-size: 0.9rem;
              padding: 4px 8px;
              width: 100%;
              outline: none;
              cursor: pointer;
            " onchange="updateCampus(this.value); if(this.value) loadStatsForCampus(this.value);">
              <option value="">Loading campuses...</option>
            </select>
          </div>
        </div>
        <div class="info-card">
          <div class="info-title">Connection</div>
          <div class="info-content">Stable</div>
        </div>
        <div class="info-card">
          <div class="info-title">Last Updated</div>
          <div class="info-content" id="last-updated">‚Äî</div>
        </div>
        <div class="info-card">
          <div class="info-title">Data Source</div>
          <div class="info-content">Google Sheets</div>
        </div>
        
        <!-- Admin Controls - Only show for admin users -->
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <div class="info-card" style="
          border: 2px solid rgba(255,193,7,0.4); 
          background: rgba(255,193,7,0.08);
          min-height: auto;
          flex: none;
          margin-top: 8px;
        ">
          <div class="info-title" style="color: #94a3b8; margin-bottom: 10px;">Admin Controls</div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <a href="{{ url_for('user_list') }}" style="
              color: #ffc107;
              text-decoration: none;
              display: block;
              padding: 8px 10px;
              border: 1px solid rgba(255,193,7,0.4);
              border-radius: 6px;
              background: rgba(255,193,7,0.15);
              text-align: center;
              font-size: 0.8rem;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255,193,7,0.25)'; this.style.transform='translateY(-1px)'" 
               onmouseout="this.style.background='rgba(255,193,7,0.15)'; this.style.transform='translateY(0)'">
              üë• Manage Users
            </a>
            <a href="{{ url_for('campus_list') }}" style="
              color: #ffc107;
              text-decoration: none;
              display: block;
              padding: 8px 10px;
              border: 1px solid rgba(255,193,7,0.4);
              border-radius: 6px;
              background: rgba(255,193,7,0.15);
              text-align: center;
              font-size: 0.8rem;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255,193,7,0.25)'; this.style.transform='translateY(-1px)'" 
               onmouseout="this.style.background='rgba(255,193,7,0.15)'; this.style.transform='translateY(0)'">
              üèõÔ∏è Manage Campuses
            </a>
            <a href="{{ url_for('logout') }}" style="
              color: #94a3b8;
              text-decoration: none;
              display: block;
              padding: 6px 10px;
              border: 1px solid rgba(148,163,184,0.3);
              border-radius: 6px;
              background: rgba(148,163,184,0.1);
              text-align: center;
              font-size: 0.75rem;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(148,163,184,0.2)'; this.style.transform='translateY(-1px)'" 
               onmouseout="this.style.background='rgba(148,163,184,0.1)'; this.style.transform='translateY(0)'">
              üö™ Logout
            </a>
          </div>
        </div>
        {% endif %}
        
        <!-- User Info for all authenticated users -->
        {% if current_user.is_authenticated %}
        <div class="info-card" style="
          border: 2px solid rgba(96,165,250,0.3); 
          background: rgba(96,165,250,0.05);
          min-height: auto;
          flex: none;
          margin-top: 8px;
        ">
          <div class="info-title" style="color: #94a3b8; margin-bottom: 10px;">Current User</div>
          <div style="color: #f1f5f9; font-weight: 600; font-size: 0.85rem; line-height: 1.3;">
            {{ current_user.full_name }}
          </div>
          <div style="color: rgba(96,165,250,0.7); font-size: 0.7rem; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">
            {{ current_user.role.replace('_', ' ').title() }}
          </div>
          <a href="{{ url_for('logout') }}" style="
            color: #94a3b8;
            text-decoration: none;
            display: block;
            padding: 6px 10px;
            border: 1px solid rgba(148,163,184,0.3);
            border-radius: 6px;
            background: rgba(148,163,184,0.1);
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='rgba(148,163,184,0.2)'; this.style.transform='translateY(-1px)'" 
             onmouseout="this.style.background='rgba(148,163,184,0.1)'; this.style.transform='translateY(0)'">
            üö™ Logout
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item" title="Home">üè†</div>
      <div class="nav-item" title="Heart" onclick="window.location.href='/heartbeat'">‚ù§Ô∏è</div>
      <div class="nav-item" title="Journey" onclick="window.location.href='/journey'">üë§</div>
      <div class="nav-item" title="Settings">‚öôÔ∏è</div>
    </div>
  </div>

  <!-- Input Modal -->
  <div class="input-modal" id="inputModal">
    <div class="input-content">
      <div class="input-title" id="inputTitle">
        {% if current_user.is_authenticated and current_user.has_permission('recall_stats') %}
          Enter Your Query
        {% else %}
          Log Statistics
        {% endif %}
      </div>
      <input type="text" class="input-field" id="queryInput" 
             placeholder="{% if current_user.is_authenticated and current_user.has_permission('recall_stats') %}Type your question or command...{% else %}Enter stats like: Paradise had 150 people, 5 new people, 3 salvations{% endif %}" 
             autocomplete="off">
      <div class="input-buttons">
        <button class="input-btn" onclick="submitQuery()">
          {% if current_user.is_authenticated and current_user.has_permission('recall_stats') %}
            Submit Query
          {% else %}
            Log Stats
          {% endif %}
        </button>
        <button class="input-btn cancel" onclick="closeInputModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Stat Logging Modal -->
  <div class="stat-modal" id="statModal">
    <div class="stat-modal-content">
      <div class="stat-modal-title" id="statModalTitle">Log Stat</div>
      <div class="stat-modal-campus" id="statModalCampus">Campus: Not Selected</div>
      <input type="number" class="stat-modal-input" id="statModalInput" placeholder="0" min="0" />
      <div class="stat-modal-buttons">
        <button class="modal-btn" onclick="submitStatInput()">Log</button>
        <button class="modal-btn cancel" onclick="hideStatModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Help Overlay -->
  <div class="help-overlay" id="helpOverlay">
    <div class="help-content">
      <button class="help-close" onclick="hideHelpOverlay()">√ó</button>
      <div class="help-title">Quick Start Guide</div>
      
      <div class="help-section">
        <h3>Voice Logging Examples:</h3>
        <div class="help-examples">
          "Paradise had 150 people, 8 first time visitors, 5 salvations"<br>
          "South campus had 200 attendance, 3 cards back, 12 youth"<br>
          "Cooper Coast had 180 people, 2 baptisms, 6 connect groups"
        </div>
      </div>

      <div class="help-section">
        <h3>Manual Entry:</h3>
        <div class="help-examples">
          1. Click any stat card to enter a number<br>
          2. Fill in as many stats as needed<br>
          3. Click "Submit Stats" when complete
        </div>
      </div>

      <div class="help-section">
        <h3>Keyboard Shortcuts:</h3>
        <div class="help-examples">
          <strong>Enter</strong> - Submit current input<br>
          <strong>Escape</strong> - Cancel/close modal<br>
          <strong>Tab</strong> - Navigate between fields
        </div>
      </div>

      <div class="help-section">
        <h3>Campus Names:</h3>
        <div class="help-examples">
          Paradise, South, Adelaide City, Salisbury, Clare Valley,<br>
          Mount Barker, Victor Harbour, Copper Coast
        </div>
      </div>

      <div class="help-section">
        <h3>Stat Types:</h3>
        <div class="help-examples">
          Attendance, First Time Visitors, Visitors, Info Gathered,<br>
          First Time Christians, Rededications, Youth, Kids,<br>
          Connect Groups, Dream Team, Baptisms, Child Dedications
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal-content">
      <div class="modal-title">Response</div>
      <div class="modal-text" id="modal-text"></div>
      <div class="modal-buttons">
        <button class="modal-button" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Role-based configuration from server
    window.userRole = {% if current_user.is_authenticated %}'{{ current_user.role }}'{% else %}null{% endif %};
    window.userCampus = {% if current_user.is_authenticated %}'{{ current_user.campus }}'{% else %}null{% endif %};
    window.userCampusName = {% if current_user.is_authenticated %}'{{ current_user.campus.replace("_", " ").title() if current_user.campus else "Unknown" }}'{% else %}null{% endif %};
    window.hasRecallPermission = {% if current_user.is_authenticated and current_user.has_permission('recall_stats') %}true{% else %}false{% endif %};

    // Initialize tsparticles orb
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize particles with delay to ensure container is ready
      setTimeout(() => {
        tsParticles.load("particles-orb", {
          fullScreen: { enable: false },
          background: { color: { value: "transparent" } },
          fpsLimit: 120,
          interactivity: {
            events: {
              onClick: { enable: true, mode: "push" },
              onHover: { enable: true, mode: "repulse" },
              resize: true,
            },
            modes: {
              push: { quantity: 4 },
              repulse: { distance: 200, duration: 0.4 },
            },
          },
          particles: {
            color: { 
              value: ["#60a5fa", "#10b981", "#8b5cf6", "#06b6d4", "#f59e0b", "#f1f5f9"]
            },
            shape: { 
              type: "circle",
            },
            links: {
              color: "#ffffff",
              distance: 150,
              enable: true,
              opacity: 0.5,
              width: 1,
            },
            collisions: { enable: true },
            move: {
              direction: "none",
              enable: true,
              outModes: { default: "bounce" },
              random: false,
              speed: 6,
              straight: false,
            },
            number: {
              density: { enable: true, area: 800 },
              value: 80,
            },
            opacity: {
              value: 0.5,
            },
            size: {
              value: { min: 1, max: 5 },
            },
          },
          detectRetina: true,
        });

        // Initialize current date
        updateCurrentDate();
        
        // Load most recent stats for current week
        loadRecentStats();
      }, 500); // 500ms delay
    });

    // Global variable to track if we're listening
    let isListening = false;

    // Show input modal
    function showModal() {
      document.getElementById('inputModal').style.display = 'flex';
      document.getElementById('queryInput').focus();
    }

    // Close input modal
    function closeInputModal() {
      document.getElementById('inputModal').style.display = 'none';
    }

    // Submit query
    function submitQuery() {
      const input = document.getElementById('queryInput').value.trim();
      if (input) {
        processInput(input);
        closeInputModal();
        document.getElementById('queryInput').value = '';
      }
    }

    // Process voice/text input
    function processInput(input) {
      console.log('Processing input:', input);
      
      // First validate campus selection
      if (!validateCampusSelection()) {
        updateListeningText('Campus required');
        setTimeout(() => updateListeningText('Ready'), 2000);
        return;
      }
      
      updateListeningText('Processing...');
      showTranscript(input);

      // Get selected campus
      const campusSelect = document.getElementById('campus-select');
      const selectedCampus = campusSelect ? campusSelect.value : '';
      
      console.log('Processing input for campus:', selectedCampus);
      
      // Send to backend
      fetch('/api/process_voice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: input,
          campus: selectedCampus
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errorData => {
            if (errorData.requires_campus_selection) {
              alert(errorData.error || 'Please select a campus first.');
              validateCampusSelection();
              updateListeningText('Campus required');
              setTimeout(() => updateListeningText('Ready'), 2000);
              return null;
            }
            throw new Error(errorData.error || 'Server error');
          });
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // Skip if campus validation failed
        console.log('Backend response:', data);
        console.log('Report data:', data.report);
        
        if (data.error) {
          console.error('Error from backend:', data.error);
          updateListeningText('Error: ' + data.error);
          setTimeout(() => updateListeningText('Ready'), 3000);
          return;
        }
        
        // Handle campus switching if detected
        if (data.campus && data.campus !== getCurrentCampus()) {
          console.log('üè´ Switching campus to:', data.campus);
          updateCampusFromResponse(data.campus);
          sessionStats.campus = data.campus;
        }

        // Update stats if provided - populate session data instead of direct display
        if (data.stats) {
          console.log('üìä Populating session stats with:', data.stats);
          
          // Set campus in session (use detected campus or current campus)
          sessionStats.campus = data.campus || getCurrentCampus();
          
          // Map backend stats to frontend stat types and populate session
          const statMap = {
            'total_attendance': 'total_attendance',
            'first_time_visitors': 'first_time_visitors', 
            'visitors': 'visitors',
            'information_gathered': 'information_gathered',
            'first_time_christians': 'first_time_christians',
            'rededications': 'rededications',
            'youth_attendance': 'youth_attendance',
            'youth_salvations': 'youth_salvations',
            'youth_new_people': 'youth_new_people',
            'kids_attendance': 'kids_attendance',
            'kids_leaders': 'kids_leaders',
            'new_kids': 'new_kids',
            'new_kids_salvations': 'new_kids_salvations',
            'connect_groups': 'connect_groups',
            'dream_team': 'dream_team',
            'baptisms': 'baptisms',
            'child_dedications': 'child_dedications',
            'tithe': 'tithe'
          };
          
          // Populate session data and update cards
          for (const [backendKey, frontendKey] of Object.entries(statMap)) {
            const value = data.stats[backendKey];
            if (value && value !== 0 && value !== '0') {
              sessionStats.data[frontendKey] = parseInt(value);
              updateStatCard(frontendKey, value);
            }
          }
          
          sessionStats.hasChanges = true;
          updateSubmitButtonState();
        }
        
        // Update current date
        updateCurrentDate();
        
        // Play audio response if available
        if (data.audio_url) {
          console.log('Playing audio response from:', data.audio_url);
          const audio = new Audio(data.audio_url);
          audio.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Show text response (check both 'text' and 'response' fields for compatibility)
        const responseText = data.text || data.response;
        if (responseText) {
          updateListeningText('Complete');
          showModal2(responseText);
          setTimeout(() => updateListeningText('Ready'), 2000);
        } else {
          updateListeningText('No response');
          setTimeout(() => updateListeningText('Ready'), 2000);
        }
      })
      .catch(error => {
        console.error('Error processing input:', error);
        updateListeningText('Error occurred');
        setTimeout(() => updateListeningText('Ready'), 3000);
      });
    }

    // Update listening text
    function updateListeningText(text) {
      document.getElementById('listening-text').textContent = text;
    }

    // Show transcript
    function showTranscript(text) {
      const display = document.getElementById('transcript-display');
      const textElement = document.getElementById('transcript-text');
      textElement.textContent = text;
      display.style.display = 'block';
      
      setTimeout(() => {
        display.style.display = 'none';
      }, 3000);
    }

    // Show modal with response
    function showModal2(message) {
      document.getElementById('modal-text').textContent = message;
      document.getElementById('modal').style.display = 'flex';
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

            // Open dashboard
        function openDashboard() {
            window.location.href = '/dashboard';
        }
        
        // Open finance dashboard
        function openFinance() {
            window.location.href = '/finance';
        }

    // Close modal when clicking outside
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Handle Enter key in input field
    document.getElementById('queryInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitQuery();
      }
    });

    // Update stats - Enhanced for all new stat cards
    function updateStats(stats) {
      // Main attendance
      if (stats.total_attendance !== undefined) {
        document.getElementById('stat-attendance').textContent = stats.total_attendance;
      }
      
      // New people breakdown
      if (stats.first_time_visitors !== undefined) {
        document.getElementById('stat-first-time').textContent = stats.first_time_visitors;
      }
      if (stats.visitors !== undefined) {
        document.getElementById('stat-visitors').textContent = stats.visitors;
      }
      if (stats.information_gathered !== undefined) {
        document.getElementById('stat-info').textContent = stats.information_gathered;
      }
      
      // Christian decisions breakdown
      if (stats.first_time_christians !== undefined) {
        document.getElementById('stat-first-time-christians').textContent = stats.first_time_christians;
      }
      if (stats.rededications !== undefined) {
        document.getElementById('stat-rededications').textContent = stats.rededications;
      }
      
      // Youth breakdown
      if (stats.youth_attendance !== undefined) {
        document.getElementById('stat-youth').textContent = stats.youth_attendance;
      }
      if (stats.youth_salvations !== undefined) {
        document.getElementById('stat-youth-salvations').textContent = stats.youth_salvations;
      }
      if (stats.youth_new_people !== undefined) {
        document.getElementById('stat-youth-new').textContent = stats.youth_new_people;
      }
      
      // Kids breakdown
      if (stats.kids_attendance !== undefined) {
        document.getElementById('stat-kids').textContent = stats.kids_attendance;
      }
      if (stats.kids_leaders !== undefined) {
        document.getElementById('stat-kids-leaders').textContent = stats.kids_leaders;
      }
      if (stats.new_kids !== undefined) {
        document.getElementById('stat-new-kids').textContent = stats.new_kids;
      }
      if (stats.new_kids_salvations !== undefined) {
        document.getElementById('stat-kids-salvations').textContent = stats.new_kids_salvations;
      }
      
      // Ministry metrics
      if (stats.connect_groups !== undefined) {
        document.getElementById('stat-connect').textContent = stats.connect_groups;
      }
      if (stats.dream_team !== undefined) {
        document.getElementById('stat-dream-team').textContent = stats.dream_team;
      }
      if (stats.tithe !== undefined) {
        document.getElementById('stat-tithe').textContent = stats.tithe;
      }
      
      // Special events
      if (stats.baptisms !== undefined) {
        document.getElementById('stat-baptisms').textContent = stats.baptisms;
      }
      if (stats.child_dedications !== undefined) {
        document.getElementById('stat-child-dedications').textContent = stats.child_dedications;
      }
      
      // Backward compatibility fallbacks
      if (stats.new_people !== undefined && !stats.first_time_visitors && !stats.visitors) {
        document.getElementById('stat-first-time').textContent = stats.new_people;
      }
      if (stats.new_christians !== undefined && !stats.first_time_christians && !stats.rededications) {
        document.getElementById('stat-first-time-christians').textContent = stats.new_christians;
      }
      if (stats.kids_total !== undefined && !stats.kids_attendance) {
        document.getElementById('stat-kids').textContent = stats.kids_total;
      }
      if (stats.volunteers !== undefined && !stats.dream_team) {
        document.getElementById('stat-dream-team').textContent = stats.volunteers;
      }
    }

    // Load most recent stats for current week
    function loadRecentStats() {
      fetch('/get_recent_stats')
        .then(response => response.json())
        .then(data => {
          if (data.stats) {
            updateStats(data.stats);
            if (data.last_logged_date) {
              updateListeningText('Last logged: ' + data.last_logged_date);
              setTimeout(() => updateListeningText('Ready'), 3000);
            }
          }
        })
        .catch(error => {
          console.log('No recent stats found:', error);
        });
    }

    // Update current date
    function updateCurrentDate() {
      const now = new Date();
      const options = { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      };
      const dateString = now.toLocaleDateString('en-US', options);
      document.getElementById('current-date').textContent = dateString;
    }

    // Update campus selection
    function updateCampus(campus) {
      if (campus) {
        fetch('/api/stats?campus=' + encodeURIComponent(campus))
          .then(response => response.json())
          .then(data => {
            console.log('Updated campus to:', campus);
            if (data.stats) {
              updateStats(data.stats);
              // Update last updated timestamp
              const now = new Date();
              document.getElementById('last-updated').textContent = now.toLocaleTimeString();
            }
          })
          .catch(error => {
            console.error('Error loading stats for campus:', error);
          });
      }
    }

    // Update campus from response detection
    function updateCampusFromResponse(campus) {
      const campusSelect = document.getElementById('campus-select');
      if (campusSelect) {
        campusSelect.value = campus;
        console.log('‚úÖ Campus auto-switched to:', campus);
        updateCampus(campus);
      }
    }

    // Load stats for specific campus
    function loadStatsForCampus(campus) {
      updateCampus(campus);
    }

    // Simulate canvas particles (fallback if tsparticles fails)
    function createCanvasParticles() {
      const container = document.getElementById('particles-orb');
      if (!container) return;
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to match container
      canvas.width = 200;
      canvas.height = 200;
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      canvas.style.position = 'absolute';
      canvas.style.top = '0';
      canvas.style.left = '0';
      canvas.style.borderRadius = '50%';
      canvas.style.zIndex = '1';
      canvas.style.pointerEvents = 'none';
      
      container.appendChild(canvas);
      
      // Create particles
      const particles = [];
      const colors = ['#60a5fa', '#10b981', '#8b5cf6', '#06b6d4', '#f59e0b', '#f1f5f9'];
      
      for (let i = 0; i < 50; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 2,
          vy: (Math.random() - 0.5) * 2,
          radius: Math.random() * 3 + 1,
          color: colors[Math.floor(Math.random() * colors.length)]
        });
      }
      
      // Animation loop
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(particle => {
          // Update position
          particle.x += particle.vx;
          particle.y += particle.vy;
          
          // Bounce off edges
          if (particle.x <= 0 || particle.x >= canvas.width) particle.vx *= -1;
          if (particle.y <= 0 || particle.y >= canvas.height) particle.vy *= -1;
          
          // Draw particle
          ctx.beginPath();
          ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
          ctx.fillStyle = particle.color;
          ctx.fill();
        });
        
        requestAnimationFrame(animate);
      }
      
      animate();
      console.log('‚úÖ Canvas particles created successfully with', particles.length, 'particles');
    }

    // Load campuses dynamically with role-based filtering
    async function loadCampuses() {
      try {
        const response = await fetch('/api/campuses');
        const data = await response.json();
        
        const campusSelect = document.getElementById('campus-select');
        if (campusSelect) {
          // Clear existing options
          campusSelect.innerHTML = '<option value="">Select Campus</option>';
          
          // Filter campuses based on user role using global variables
          if (window.userRole === 'campus_pastor') {
            // Campus pastors see only their campus
            const filteredCampuses = data.campuses.filter(campus => 
              campus.id === window.userCampus
            );
            
            if (filteredCampuses.length > 0) {
              filteredCampuses.forEach(campus => {
                const option = document.createElement('option');
                option.value = campus.id;
                option.textContent = campus.name;
                option.selected = true; // Auto-select their campus
                campusSelect.appendChild(option);
              });
            } else {
              // Fallback if their campus isn't found
              const option = document.createElement('option');
              option.value = window.userCampus;
              option.textContent = window.userCampusName;
              option.selected = true;
              campusSelect.appendChild(option);
            }
            
            console.log('‚úÖ Loaded campus for campus pastor:', window.userCampusName);
          } else {
            // Admins, senior leaders, and unauthenticated users see all campuses
            data.campuses.forEach(campus => {
              const option = document.createElement('option');
              option.value = campus.id;
              option.textContent = campus.name;
              campusSelect.appendChild(option);
            });
            
            console.log('‚úÖ Loaded', data.campuses.length, 'campuses for', window.userRole || 'anonymous user');
          }
        }
      } catch (error) {
        console.error('‚ùå Failed to load campuses:', error);
        
        // Fallback to basic options on error
        const campusSelect = document.getElementById('campus-select');
        if (campusSelect) {
          if (window.userRole === 'campus_pastor') {
            campusSelect.innerHTML = `
              <option value="${window.userCampus}" selected>${window.userCampusName}</option>
            `;
          } else {
            campusSelect.innerHTML = `
              <option value="">Select Campus</option>
              <option value="all_campuses">All Campuses</option>
              <option value="paradise">Paradise</option>
              <option value="south">South</option>
            `;
          }
        }
      }
    }

    // Initialize campus loading
    loadCampuses();

    // Make functions globally available
    window.showModal = showModal;
    window.updateListeningText = updateListeningText;
    window.updateStats = updateStats;
    window.updateCurrentDate = updateCurrentDate;

    // Check if campus is selected
    function getCurrentCampus() {
      const campusSelect = document.getElementById('campus-select');
      return campusSelect ? campusSelect.value : '';
    }

    // Validate campus selection and prompt if needed
    function validateCampusSelection() {
      const currentCampus = getCurrentCampus();
      
      if (!currentCampus) {
        alert('Please select a campus first before logging stats.\n\nYou can select your campus from the dropdown in the right panel.');
        
        // Highlight the campus selector to draw attention
        const campusSelect = document.getElementById('campus-select');
        if (campusSelect) {
          campusSelect.style.border = '2px solid #ef4444';
          campusSelect.focus();
          
          // Remove highlight after 3 seconds
          setTimeout(() => {
            campusSelect.style.border = '1px solid rgba(96,165,250,0.3)';
          }, 3000);
        }
        
        return false;
      }
      
      return true;
    }

    // Global variables for stat logging
    let currentStatType = null;
    let currentStatPrompt = null;
    
    // Session data collection for batch logging
    let sessionStats = {
      campus: null,
      data: {},
      hasChanges: false
    };

    // Stat logging function for clickable cards
    function logStat(statType) {
      // First check if campus is selected
      if (!validateCampusSelection()) {
        return;
      }
      
      const currentCampus = getCurrentCampus();
      console.log('Logging stat for campus:', currentCampus);
      
      const prompts = {
        'total_attendance': 'Total attendance was',
        'first_time_visitors': 'First time visitors were',
        'visitors': 'Visitors were', 
        'information_gathered': 'Information gathered from',
        'first_time_christians': 'First time Christians were',
        'rededications': 'Rededications were',
        'youth_attendance': 'Youth attendance was',
        'youth_salvations': 'Youth salvations were',
        'youth_new_people': 'Youth new people were',
        'kids_attendance': 'Kids attendance was',
        'kids_leaders': 'Kids leaders were',
        'new_kids': 'New kids were',
        'new_kids_salvations': 'New kids salvations were',
        'connect_groups': 'Connect groups were',
        'dream_team': 'Dream team members were',
        'baptisms': 'Baptisms were',
        'child_dedications': 'Child dedications were',
        'tithe': 'Tithe was'
      };
      
      const statLabels = {
        'total_attendance': 'Total Attendance',
        'first_time_visitors': 'First Time Visitors',
        'visitors': 'Visitors', 
        'information_gathered': 'Information Gathered',
        'first_time_christians': 'First Time Christians',
        'rededications': 'Rededications',
        'youth_attendance': 'Youth Attendance',
        'youth_salvations': 'Youth Salvations',
        'youth_new_people': 'Youth New People',
        'kids_attendance': 'Kids Attendance',
        'kids_leaders': 'Kids Leaders',
        'new_kids': 'New Kids',
        'new_kids_salvations': 'New Kids Salvations',
        'connect_groups': 'Connect Groups',
        'dream_team': 'Dream Team',
        'baptisms': 'Baptisms',
        'child_dedications': 'Child Dedications',
        'tithe': 'Tithe'
      };
      
      currentStatType = statType;
      currentStatPrompt = prompts[statType] || statType + ' was';
      
      // Show custom modal instead of browser prompt
      showStatModal(statLabels[statType] || statType, getCurrentCampusName());
    }

    // Show stat logging modal
    function showStatModal(statLabel, campusName) {
      const modal = document.getElementById('statModal');
      const title = document.getElementById('statModalTitle');
      const campus = document.getElementById('statModalCampus');
      const input = document.getElementById('statModalInput');
      
      title.textContent = `Log ${statLabel}`;
      campus.textContent = `Campus: ${campusName}`;
      input.value = '';
      input.focus();
      
      modal.style.display = 'flex';
      
      // Handle keyboard shortcuts
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitStatInput();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideStatModal();
        }
      });
    }

    // Hide stat logging modal
    function hideStatModal() {
      const modal = document.getElementById('statModal');
      modal.style.display = 'none';
      currentStatType = null;
      currentStatPrompt = null;
    }

    // Submit stat input from modal
    function submitStatInput() {
      const input = document.getElementById('statModalInput');
      const value = input.value.trim();
      
      // Validation
      if (!value) {
        showModalError('Please enter a number');
        return;
      }
      
      if (isNaN(value)) {
        showModalError('Please enter a valid number');
        return;
      }
      
      const numValue = parseInt(value);
      if (numValue < 0) {
        showModalError('Number cannot be negative');
        return;
      }
      
      if (numValue > 10000) {
        showModalError('Number seems too large. Please check and try again.');
        return;
      }
      
      // Create a stat entry string
      const statEntry = currentStatPrompt + ' ' + value;
      
      // Hide modal first
      hideStatModal();
      
      // Store in session data instead of immediate submission
      const currentCampus = getCurrentCampus();
      sessionStats.campus = currentCampus;
      sessionStats.data[currentStatType] = numValue;
      sessionStats.hasChanges = true;
      
      // Update the stat card display immediately
      updateStatCard(currentStatType, value);
      
      // Show feedback
      showNotification(`${currentStatPrompt} ${value} - Ready to submit when complete`, 'info');
    }

    // Show error in modal
    function showModalError(message) {
      const input = document.getElementById('statModalInput');
      input.style.borderColor = '#ef4444';
      input.style.boxShadow = '0 0 10px rgba(239,68,68,0.3)';
      
      // Create or update error message
      let errorDiv = document.getElementById('statModalError');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'statModalError';
        errorDiv.style.cssText = 'color: #ef4444; font-size: 0.8rem; margin-top: 8px; text-align: center;';
        input.parentNode.insertBefore(errorDiv, input.nextSibling);
      }
      errorDiv.textContent = message;
      
      // Clear error after 3 seconds
      setTimeout(() => {
        input.style.borderColor = 'rgba(96,165,250,0.3)';
        input.style.boxShadow = 'none';
        if (errorDiv) errorDiv.remove();
      }, 3000);
    }

    // Update individual stat card display
    function updateStatCard(statType, value) {
      const statMappings = {
        'total_attendance': 'stat-attendance',
        'first_time_visitors': 'stat-first-time',
        'visitors': 'stat-visitors',
        'information_gathered': 'stat-info',
        'first_time_christians': 'stat-first-time-christians',
        'rededications': 'stat-rededications',
        'youth_attendance': 'stat-youth',
        'youth_salvations': 'stat-youth-salvations',
        'youth_new_people': 'stat-youth-new',
        'kids_attendance': 'stat-kids',
        'kids_leaders': 'stat-kids-leaders',
        'new_kids': 'stat-new-kids',
        'new_kids_salvations': 'stat-kids-salvations',
        'connect_groups': 'stat-connect',
        'dream_team': 'stat-dream-team',
        'baptisms': 'stat-baptisms',
        'child_dedications': 'stat-child-dedications',
        'tithe': 'stat-tithe'
      };
      
      const elementId = statMappings[statType];
      if (elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = value;
          element.style.color = '#60a5fa'; // Highlight filled data
          element.parentElement.style.borderColor = '#60a5fa'; // Highlight card border
        }
      }
      
      updateSubmitButtonState();
    }

    // Update submit button state based on collected data
    function updateSubmitButtonState() {
      const submitBtn = document.getElementById('submitStatsBtn');
      const clearBtn = document.getElementById('clearStatsBtn');
      const hasData = Object.keys(sessionStats.data).length > 0;
      
      if (submitBtn) {
        submitBtn.style.display = hasData ? 'block' : 'none';
        submitBtn.textContent = `Submit ${Object.keys(sessionStats.data).length} Stats for ${sessionStats.campus || 'Campus'}`;
      }
      
      if (clearBtn) {
        clearBtn.style.display = hasData ? 'block' : 'none';
      }
    }

    // Submit all collected stats
    function submitAllStats() {
      if (!sessionStats.hasChanges || Object.keys(sessionStats.data).length === 0) {
        showNotification('No stats to submit', 'warning');
        return;
      }
      
      if (!sessionStats.campus) {
        showNotification('Please select a campus first', 'error');
        return;
      }
      
      // Prevent double submission
      const submitBtn = document.getElementById('submitStatsBtn');
      if (submitBtn.disabled) {
        return;
      }
      
      // Convert session data to text format for backend processing
      const statPhrases = [];
      const prompts = {
        'total_attendance': 'Total attendance was',
        'first_time_visitors': 'First time visitors were',
        'visitors': 'Visitors were',
        'information_gathered': 'Information gathered from',
        'first_time_christians': 'First time Christians were',
        'rededications': 'Rededications were',
        'youth_attendance': 'Youth attendance was',
        'youth_salvations': 'Youth salvations were',
        'youth_new_people': 'Youth new people were',
        'kids_attendance': 'Kids attendance was',
        'kids_leaders': 'Kids leaders were',
        'new_kids': 'New kids were',
        'new_kids_salvations': 'New kids salvations were',
        'connect_groups': 'Connect groups were',
        'dream_team': 'Dream team members were',
        'baptisms': 'Baptisms were',
        'child_dedications': 'Child dedications were',
        'tithe': 'Tithe was'
      };
      
      for (const [statType, value] of Object.entries(sessionStats.data)) {
        const prompt = prompts[statType] || `${statType} was`;
        statPhrases.push(`${prompt} ${value}`);
      }
      
      const combinedText = statPhrases.join(', ');
      
      // Show loading state
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.6';
      
      // Add timeout for submission
      const submissionTimeout = setTimeout(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        showNotification('Submission timeout. Please try again.', 'error');
      }, 30000); // 30 second timeout
      
      // Direct API call to submit all stats
      fetch('/api/process_voice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: combinedText,
          campus: sessionStats.campus
        })
      })
      .then(response => {
        clearTimeout(submissionTimeout);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Success - clear session data
        const submittedCount = Object.keys(sessionStats.data).length;
        const campus = sessionStats.campus;
        
        sessionStats = {
          campus: null,
          data: {},
          hasChanges: false
        };
        
        // Reset all stat cards
        const statElements = document.querySelectorAll('.stat-number');
        statElements.forEach(element => {
          element.textContent = '‚Äî';
          element.style.color = '#f1f5f9'; // Reset to default color
          element.parentElement.style.borderColor = '#475569'; // Reset border
        });
        
        updateSubmitButtonState();
        showNotification(`Successfully submitted ${submittedCount} stats for ${campus}!`, 'success');
      })
      .catch(error => {
        clearTimeout(submissionTimeout);
        console.error('Error submitting stats:', error);
        
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        
        // Show specific error message
        let errorMessage = 'Error submitting stats. Please try again.';
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Network error. Check your connection and try again.';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Request timed out. Please try again.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showNotification(errorMessage, 'error');
      });
    }

    // Clear all session data
    function clearAllStats() {
      sessionStats = {
        campus: null,
        data: {},
        hasChanges: false
      };
      
      // Reset all stat card displays
      const statElements = document.querySelectorAll('.stat-number');
      statElements.forEach(element => {
        element.textContent = '‚Äî';
        element.style.color = '#f1f5f9'; // Reset to default color
        element.parentElement.style.borderColor = '#475569'; // Reset border
      });
      
      updateSubmitButtonState();
      showNotification('All stats cleared', 'info');
    }

    // Simple notification function
    function showNotification(message, type) {
      const listeningText = document.getElementById('listening-text');
      if (listeningText) {
        const originalText = listeningText.textContent;
        listeningText.textContent = message;
        setTimeout(() => {
          listeningText.textContent = originalText;
        }, 3000);
      } else {
        console.log(`${type.toUpperCase()}: ${message}`);
      }
    }

    // Help overlay functions
    function showHelpOverlay() {
      const overlay = document.getElementById('helpOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function hideHelpOverlay() {
      const overlay = document.getElementById('helpOverlay');
      if (overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Close help overlay on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const helpOverlay = document.getElementById('helpOverlay');
        const statModal = document.getElementById('statModal');
        
        if (helpOverlay && helpOverlay.style.display === 'flex') {
          hideHelpOverlay();
        } else if (statModal && statModal.style.display === 'flex') {
          hideStatModal();
        }
      }
    });

    // Get current campus display name
    function getCurrentCampusName() {
      const campusSelect = document.getElementById('campus-select');
      if (!campusSelect) return 'Unknown Campus';
      
      const selectedOption = campusSelect.options[campusSelect.selectedIndex];
      return selectedOption ? selectedOption.textContent : 'Unknown Campus';
    }

    window.showTranscript = showTranscript;
    window.updateCampus = updateCampus;
    window.updateCampusFromResponse = updateCampusFromResponse;
    window.speakText = speakText;
    window.loadStatsForCampus = loadStatsForCampus;
    window.loadCampuses = loadCampuses;
    window.logStat = logStat;

    console.log('Dashboard initialized successfully!');
  </script>
</body>
</html> 